# WebRTC通話に必要な情報一覧

## 概要

WebRTC（Web Real-Time Communication）でP2P通話を確立するには、以下の3種類の情報を両デバイス間で交換する必要があります。

---

## 1. SDP Offer（発信側 → 受信側）

### 説明
発信側（Caller）が生成する、メディアセッションの提案情報です。

### 含まれる情報
- **メディアタイプ**: 音声（audio）、映像（video）
- **コーデック**: 使用する音声・映像の圧縮形式（例: Opus, H.264, VP8）
- **解像度**: 映像の場合の画面サイズ
- **ビットレート**: データ転送速度
- **暗号化**: DTLS-SRTP による暗号化情報
- **ネットワーク情報**: 初期接続候補

### フォーマット
```json
{
  "type": "offer",
  "sdp": "v=0\r\no=- 1234567890123456 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0 1\r\n..."
}
```

### サイズ
- 通常: 2,000〜4,000文字
- ビデオ有効時: 3,000〜5,000文字

### 生成タイミング
発信側が「通話」ボタンをタップした直後

### 交換方法
発信側 → 受信側へコピー＆ペースト、またはシグナリングサーバー経由

---

## 2. SDP Answer（受信側 → 発信側）

### 説明
受信側（Receiver）が生成する、Offerに対する応答情報です。

### 含まれる情報
- **受け入れ可能なメディアタイプ**: OfferされたメディアをAcceptするか
- **コーデック選択**: 双方がサポートするコーデックから最適なものを選択
- **解像度調整**: 受信可能な解像度
- **暗号化情報**: DTLS-SRTP の応答
- **ネットワーク情報**: 受信側の初期接続候補

### フォーマット
```json
{
  "type": "answer",
  "sdp": "v=0\r\no=- 9876543210987654 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0 1\r\n..."
}
```

### サイズ
- 通常: 2,000〜4,000文字
- ビデオ有効時: 3,000〜5,000文字

### 生成タイミング
受信側がOfferを受信して処理した直後

### 交換方法
受信側 → 発信側へコピー＆ペースト、またはシグナリングサーバー経由

---

## 3. ICE候補（Interactive Connectivity Establishment）

### 説明
両デバイス間の実際のネットワーク接続経路を見つけるための候補情報です。

### 含まれる情報
- **IPアドレス**: デバイスのローカルIPまたはパブリックIP
- **ポート番号**: 通信に使用するポート
- **プロトコル**: UDP または TCP
- **候補タイプ**:
  - **host**: ローカルネットワーク内のアドレス（最優先）
  - **srflx**: NAT越しのパブリックアドレス（STUNサーバー経由）
  - **relay**: リレーサーバー経由のアドレス（TURNサーバー経由、最終手段）
- **優先度**: 接続試行の優先順位

### フォーマット
```json
{
  "candidate": "candidate:1234567890 1 udp 2130706431 192.168.1.100 54321 typ host generation 0 ufrag ABCD network-id 1",
  "sdpMLineIndex": 0,
  "sdpMid": "0"
}
```

### サイズ
1個あたり: 200〜500文字

### 数量
- 各デバイスで通常 **3〜10個** 生成される
- ネットワーク環境により増減
  - Wi-Fi + 有線LAN → 多い
  - モバイルネットワークのみ → 少ない

### 生成タイミング
SDP Offer/Answer交換後、数秒かけて順次生成される

### 交換方法
生成されるたびに、即座に相手に送信（双方向）

---

## 情報交換の流れ

### タイムライン

```
発信側（Caller）                      受信側（Receiver）
     |                                        |
     | 1. SDP Offer生成                       |
     |---------------------------------------->|
     |        （2,000〜4,000文字）             |
     |                                        | 2. Offerを処理
     |                                        | 3. SDP Answer生成
     |<----------------------------------------|
     |        （2,000〜4,000文字）             |
     | 4. Answerを処理                        |
     |                                        |
     | 5. ICE候補生成 (3〜10個)               | 6. ICE候補生成 (3〜10個)
     |<--------------------------------------->|
     |        （各200〜500文字）               |
     |                                        |
     | 7. 接続試行...                         | 8. 接続試行...
     |========================================|
     |         P2P接続確立 ✅                 |
     |========================================|
     |                                        |
     | 音声・映像データ（直接通信）            |
     |<======================================>|
```

### ステップ詳細

1. **発信側**: 「通話」ボタンをタップ → Offer生成
2. **発信側**: Offerを受信側に送信
3. **受信側**: Offerを受信 → 処理 → Answer生成
4. **受信側**: Answerを発信側に送信
5. **発信側**: Answerを受信 → 処理
6. **両方**: ICE候補を順次生成 → 相互に送信
7. **両方**: 受信したICE候補を順次追加
8. **両方**: 最適な接続経路を見つけて確立
9. **通話開始**: 音声・映像データが直接通信される

---

## 手動交換の場合の注意点

### コピー＆ペーストの注意
⚠️ **すべての文字を正確にコピー**してください
- 先頭や末尾の空白・改行を含む
- JSON形式が壊れると接続失敗
- 手入力は絶対に避ける

### ICE候補の交換
⚠️ **すべての候補を交換**してください
- 1つでも欠けると接続できない可能性
- 生成されるたびに順次交換
- 「これで全部？」と確認を

### タイムアウト
⚠️ **素早く交換**してください
- ICE候補の有効期限は短い（数分）
- 時間がかかると再生成が必要

---

## 自動シグナリングとの比較

| 項目 | 手動交換 | 自動シグナリング |
|------|---------|----------------|
| **Offer/Answer** | コピー＆ペースト | WebSocket送信 |
| **ICE候補** | 順次コピー＆ペースト | 自動送信 |
| **所要時間** | 1〜3分 | 数秒 |
| **手間** | 大変 | 簡単 |
| **エラー可能性** | 高い | 低い |
| **学習価値** | 高い（仕組みがわかる） | 低い（ブラックボックス） |

---

## よくある質問

### Q1: なぜこんなに情報が必要なの？
A: WebRTCはP2P（ピア・トゥ・ピア）通信です。中央サーバーを経由せずに直接接続するため、両デバイスが互いのネットワーク情報を知る必要があります。

### Q2: 音声データや映像データも交換するの？
A: いいえ。ここで交換するのは**接続情報のみ**です。実際の音声・映像データは、P2P接続確立後に**暗号化された直接通信**で送られます。

### Q3: ICE候補は全部送らないとダメ？
A: 理論的には1つでも接続できる場合がありますが、**全部送るのが確実**です。ネットワーク環境により使える候補が異なるため。

### Q4: Offerを先に送らないとダメ？
A: はい。WebRTCの仕様上、**Offer → Answer** の順序は固定です。逆にすると接続できません。

### Q5: 情報を他人に見られても大丈夫？
A: SDP/ICE候補には暗号化キーは含まれませんが、**プライベートIPアドレス**が含まれる場合があります。不特定多数に公開するのは避けましょう。

---

## まとめ

### 必要な情報（再掲）

1. ✅ **SDP Offer**（発信側→受信側）: 2,000〜4,000文字
2. ✅ **SDP Answer**（受信側→発信側）: 2,000〜4,000文字
3. ✅ **ICE候補**（両方向）: 各3〜10個 × 200〜500文字

### 合計データ量
- **約4,000〜10,000文字**（両方向合計）
- メール、SMS、メッセージアプリで十分交換可能

### 交換方法
- **手動**: コピー＆ペースト（開発・テスト用）
- **自動**: シグナリングサーバー（本番用）

---

**これらの情報を正確に交換できれば、WebRTC通話が確立します！**

