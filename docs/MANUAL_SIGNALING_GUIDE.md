# 🔧 手動シグナリング機能ガイド

## 概要

手動シグナリング機能を使用すると、**シグナリングサーバーなし**でWebRTC通話をテストできます。接続に必要な情報（SDP、ICE候補）を手動で交換することで、2台のデバイス間で実際のP2P通話が可能になります。

## 通話に必要な情報

WebRTC通話を確立するには、以下の3種類の情報を交換する必要があります：

### 1. **SDP Offer**（発信側→受信側）
- **何か**: 発信側のメディア情報（コーデック、解像度など）と接続情報
- **サイズ**: 約2,000〜4,000文字
- **フォーマット**: JSON形式
```json
{
  "type": "offer",
  "sdp": "v=0\r\no=- 1234567890 2 IN IP4 127.0.0.1\r\n..."
}
```

### 2. **SDP Answer**（受信側→発信側）
- **何か**: 受信側のメディア情報と接続情報
- **サイズ**: 約2,000〜4,000文字
- **フォーマット**: JSON形式
```json
{
  "type": "answer",
  "sdp": "v=0\r\no=- 9876543210 2 IN IP4 127.0.0.1\r\n..."
}
```

### 3. **ICE候補**（両方向、複数個）
- **何か**: ネットワーク接続情報（IPアドレス、ポート）
- **数量**: 通常3〜10個（各デバイス）
- **サイズ**: 1個あたり約200〜500文字
- **フォーマット**: JSON形式
```json
{
  "candidate": "candidate:1 1 UDP 2130706431 192.168.1.100 54321 typ host",
  "sdpMLineIndex": 0,
  "sdpMid": "0"
}
```

## 使用方法

### 準備

両方のデバイスで：
1. アプリを起動
2. メイン画面で「手動シグナリング（サーバー不要）」をONにする
3. 「通話」ボタンをタップ

### 発信側（Caller）の手順

#### Step 1: Offerを生成
1. 「発信側（Caller）」を選択
2. 「Offerを生成」ボタンをタップ
3. 生成されたOfferをコピー
4. メール、SMS、メッセージアプリなどで受信側に送信

#### Step 2: Answerを受け取る
1. 受信側から送られてきたAnswerをコピー
2. アプリのAnswer入力欄に貼り付け
3. 「Answerを設定」ボタンをタップ

#### Step 3: ICE候補を交換
1. **あなたのICE候補を送信**:
   - 画面に表示される各ICE候補をコピー
   - 順次、受信側に送信
   
2. **相手のICE候補を入力**:
   - 受信側から送られてきたICE候補をコピー
   - アプリのICE候補入力欄に貼り付け
   - 「ICE候補を追加」ボタンをタップ
   - 届いた候補すべてについて繰り返す

3. 接続が確立されると自動的に通話画面に遷移

### 受信側（Receiver）の手順

#### Step 1: Offerを受け取ってAnswerを生成
1. 「受信側（Receiver）」を選択
2. 発信側から送られてきたOfferをコピー
3. アプリのOffer入力欄に貼り付け
4. 「Offerを設定してAnswerを生成」ボタンをタップ
5. 生成されたAnswerをコピー
6. 発信側に送信

#### Step 2: ICE候補を交換
1. **あなたのICE候補を送信**:
   - 画面に表示される各ICE候補をコピー
   - 順次、発信側に送信
   
2. **相手のICE候補を入力**:
   - 発信側から送られてきたICE候補をコピー
   - アプリのICE候補入力欄に貼り付け
   - 「ICE候補を追加」ボタンをタップ
   - 届いた候補すべてについて繰り返す

3. 接続が確立されると自動的に通話画面に遷移

## 情報の交換方法

以下のいずれかの方法で情報を交換できます：

### 同じ場所にいる場合
- **AirDrop**（iOS同士）
- **Bluetooth/NFC共有**（Android）
- **QRコード**（別のアプリを使用）
- **直接見せ合う**（コピー＆ペースト）

### 離れた場所にいる場合
- **メッセージアプリ**（LINE、Telegram、WhatsAppなど）
- **メール**
- **SMS**
- **Slack/Discord**などのチャットアプリ

### 注意点
⚠️ 情報のサイズが大きいため、**コピー＆ペーストが確実**です
⚠️ 手入力は**推奨しません**（エラーの原因になります）

## トラブルシューティング

### Offerが生成されない
- カメラ/マイクの権限を確認してください
- アプリを再起動してください

### Answerの設定に失敗する
- OfferのJSON形式が正しいか確認してください
- 全文がコピーされているか確認してください

### ICE候補を追加できない
- JSON形式が正しいか確認してください
- 余分なスペースや改行がないか確認してください

### 接続が確立されない
- **すべてのICE候補を追加したか確認**してください
  - 通常、各デバイスで3〜10個生成されます
  - 画面に表示されている数を確認してください
- 両方のデバイスが**同じネットワーク**にいる場合、接続しやすくなります
- ファイアウォールやVPNが接続を妨げている可能性があります

### 通話が途切れる
- ネットワーク接続を確認してください
- デバイス間の距離が遠すぎる可能性があります（リレーサーバーが必要）

## 技術的な背景

### なぜ手動交換が可能か？

WebRTCの接続確立は、以下の3ステップで行われます：

1. **SDP Offer/Answer交換**: メディア情報と接続方法の合意
2. **ICE候補交換**: 実際の接続経路の探索
3. **P2P接続確立**: 直接通信の開始

通常、これらの情報交換は**シグナリングサーバー**を介して自動で行われますが、手動で交換しても全く同じ結果が得られます。

### 自動シグナリングとの違い

| 項目 | 手動シグナリング | 自動シグナリング |
|------|----------------|----------------|
| **シグナリングサーバー** | 不要 | 必要 |
| **情報交換** | 手動コピー＆ペースト | 自動 |
| **セットアップ時間** | 1〜3分 | 数秒 |
| **利用シーン** | 開発・テスト | 本番環境 |
| **メディア通信** | P2P（直接通信） | P2P（直接通信） |
| **音声/映像品質** | 同じ | 同じ |

### メリット

✅ **シグナリングサーバー不要**: インフラコストゼロ  
✅ **開発・テストに最適**: すぐに試せる  
✅ **学習用途**: WebRTCの仕組みが理解できる  
✅ **プライバシー**: 第三者のサーバーを経由しない  

### デメリット

❌ **手間がかかる**: 手動でコピー＆ペースト  
❌ **リアルタイム性がない**: 情報交換に時間がかかる  
❌ **スケールしない**: 多人数通話は実質不可能  
❌ **ユーザーフレンドリーではない**: 一般ユーザーには難しい  

## 本番環境への移行

手動シグナリングで動作確認ができたら、次のステップとして**自動シグナリングサーバー**の実装を検討してください：

### 1. シグナリングサーバーの選択肢

#### 自前で構築
- **WebSocket**サーバー（Node.js + Socket.io）
- **Firebase Realtime Database / Firestore**
- **AWS AppSync**（GraphQL Subscriptions）

#### サードパーティサービス
- **Twilio Programmable Video**
- **Agora.io**
- **Amazon Chime SDK**
- **Daily.co**

### 2. 実装の変更点

現在の`SignalingService.ts`を拡張：

```typescript
// 手動モード（現在の実装）
sendSignalingMessage(message) {
  // ローカルシミュレーション
  this.handleIncomingMessage(message);
}

// 自動モード（シグナリングサーバー使用）
sendSignalingMessage(message) {
  // WebSocketで送信
  this.websocket.send(JSON.stringify(message));
}
```

### 3. 開発の優先順位

1. ✅ **手動シグナリングで動作確認**（現在）
2. 🔄 **Development Buildで実機テスト**
3. 🔄 **簡単なシグナリングサーバー実装**
4. 🔄 **本番環境デプロイ**

## まとめ

手動シグナリング機能により、**今すぐ**WebRTC通話をテストできます。

### 次のステップ
1. この機能を使って2台のデバイスで通話してみる
2. 音声・映像の品質を確認する
3. 問題があればWebRTCServiceを調整する
4. 動作確認ができたらシグナリングサーバーの実装を検討する

---

**質問や問題があれば、このドキュメントを参照してください。**

